generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Locale {
  EN
  FR
}

enum UserRole {
  CUSTOMER
  EDITOR
  MERCHANDISER
  ADMIN
}

enum ProductStatus {
  DRAFT
  PREORDER
  ACTIVE
  ARCHIVED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  FULFILLED
  CANCELLED
  REFUNDED
}

enum FulfillmentStatus {
  NOT_STARTED
  IN_PROGRESS
  SHIPPED
  DELIVERED
  WHITE_GLOVE_SCHEDULED
}

enum PaymentStatus {
  UNPAID
  AUTHORIZED
  PAID
  REFUNDED
}

enum Currency {
  EUR
  USD
}

enum MediaType {
  IMAGE
  VIDEO
}

enum EditorialCategory {
  COLLECTION
  JOURNAL
  MAISON
  CAMPAIGN
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  passwordHash            String?
  firstName               String?
  lastName                String?
  role                    UserRole                 @default(CUSTOMER)
  locale                  Locale                   @default(EN)
  phone                   String?
  marketingOptIn          Boolean                  @default(false)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  accounts                Account[]
  sessions                Session[]
  addresses               Address[]
  carts                   Cart[]
  orders                  Order[]
  appointments            Appointment[]
  personalizationRequests PersonalizationRequest[]
  editorialPosts          EditorialPost[]
  wishlists               Wishlist[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Address {
  id             String  @id @default(cuid())
  label          String?
  firstName      String
  lastName       String
  line1          String
  line2          String?
  city           String
  region         String?
  postalCode     String
  country        String  @default("FR")
  phone          String?
  isDefault      Boolean @default(false)
  userId         String?
  user           User?   @relation(fields: [userId], references: [id])
  ordersShipping Order[] @relation("OrderShipping")
  ordersBilling  Order[] @relation("OrderBilling")
}

model Category {
  id           String                @id @default(cuid())
  slug         String                @unique
  parentId     String?
  parent       Category?             @relation("CategoryChildren", fields: [parentId], references: [id])
  children     Category[]            @relation("CategoryChildren")
  translations CategoryTranslation[]
  products     Product[]
}

model CategoryTranslation {
  id          String   @id @default(cuid())
  title       String
  description String?
  locale      Locale
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, locale])
}

model Material {
  id                  String            @id @default(cuid())
  name                String
  origin              String?
  sustainabilityNotes String?
  products            ProductMaterial[]
}

model Product {
  id                String                   @id @default(cuid())
  slug              String                   @unique
  skuPrefix         String?
  status            ProductStatus            @default(DRAFT)
  originCountry     String?                  @default("FR")
  atelierNotes      String?
  limitedEdition    Boolean                  @default(false)
  dropDate          DateTime?
  heritageTag       String?
  careInstructions  Json?
  seoMeta           Json?
  weightGrams       Int?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  categoryId        String?
  category          Category?                @relation(fields: [categoryId], references: [id])
  translations      ProductTranslation[]
  materials         ProductMaterial[]
  variants          ProductVariant[]
  media             ProductMedia[]
  collections       CollectionItem[]
  spotlightModules  ProductSpotlightModule[]
  waitlistEntries   WaitlistEntry[]
  editorialFeatures EditorialFeature[]
  wishlistEntries   WishlistItem[]
}

model ProductTranslation {
  id             String  @id @default(cuid())
  locale         Locale
  name           String
  description    String?
  craftStory     String?
  materialsText  String?
  sizeGuide      String?
  seoTitle       String?
  seoDescription String?
  productId      String
  product        Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
}

model ProductVariant {
  id                      String                   @id @default(cuid())
  sku                     String                   @unique
  productId               String
  product                 Product                  @relation(fields: [productId], references: [id], onDelete: Cascade)
  color                   String
  size                    String?
  materialMix             String?
  priceCents              Int
  compareAtCents          Int?
  currency                Currency                 @default(EUR)
  availableFrom           DateTime?
  personalizationAllowed  Boolean                  @default(false)
  weightGrams             Int?
  inventory               Inventory?
  cartItems               CartItem[]
  orderItems              OrderItem[]
  personalizationRequests PersonalizationRequest[]
  media                   ProductVariantMedia[]
}

model Inventory {
  id                String                @id @default(cuid())
  variantId         String                @unique
  variant           ProductVariant        @relation(fields: [variantId], references: [id], onDelete: Cascade)
  quantity          Int                   @default(0)
  reserved          Int                   @default(0)
  lowStockThreshold Int                   @default(2)
  adjustments       InventoryAdjustment[]
}

model InventoryAdjustment {
  id          String    @id @default(cuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  change      Int
  reason      String?
  createdAt   DateTime  @default(now())
}

model ProductMaterial {
  id         String   @id @default(cuid())
  productId  String
  materialId String
  percentage Float?
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([productId, materialId])
}

model MediaAsset {
  id               String                   @id @default(cuid())
  type             MediaType
  url              String
  alt              String?
  focalPoint       Json?
  width            Int?
  height           Int?
  duration         Int?
  publicId         String?
  provider         String?
  createdAt        DateTime                 @default(now())
  productMedia     ProductMedia[]
  variantMedia     ProductVariantMedia[]
  editorialMedia   EditorialBlock[]
  collectionMedia  CollectionSection[]
  collectionHeroes Collection[]             @relation("CollectionHeroAsset")
  editorialHeroes  EditorialPost[]          @relation("EditorialHeroAsset")
  lookbookSlides   LookbookSlide[]          @relation("LookbookSlideAsset")
  spotlightModules ProductSpotlightModule[] @relation("ProductSpotlightAsset")
}

model ProductMedia {
  id          String     @id @default(cuid())
  productId   String
  product     Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  assetId     String
  asset       MediaAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  placement   String
  sortOrder   Int        @default(0)
  hotspotData Json?
}

model ProductVariantMedia {
  id        String         @id @default(cuid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  assetId   String
  asset     MediaAsset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  sortOrder Int            @default(0)
}

model Collection {
  id             String                  @id @default(cuid())
  slug           String                  @unique
  season         String?
  releaseDate    DateTime?
  status         ProductStatus           @default(DRAFT)
  heroAssetId    String?
  heroAsset      MediaAsset?             @relation("CollectionHeroAsset", fields: [heroAssetId], references: [id])
  translations   CollectionTranslation[]
  sections       CollectionSection[]
  items          CollectionItem[]
  lookbookSlides LookbookSlide[]
  drops          LimitedDrop[]
}

model CollectionTranslation {
  id             String     @id @default(cuid())
  locale         Locale
  title          String
  subtitle       String?
  description    String?
  manifesto      String?
  seoTitle       String?
  seoDescription String?
  collectionId   String
  collection     Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, locale])
}

model CollectionSection {
  id           String                         @id @default(cuid())
  collectionId String
  collection   Collection                     @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  assetId      String?
  asset        MediaAsset?                    @relation(fields: [assetId], references: [id])
  sortOrder    Int                            @default(0)
  layout       String
  translations CollectionSectionTranslation[]
}

model CollectionSectionTranslation {
  id        String            @id @default(cuid())
  locale    Locale
  heading   String?
  body      String?
  caption   String?
  sectionId String
  section   CollectionSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([sectionId, locale])
}

model CollectionItem {
  id           String     @id @default(cuid())
  collectionId String
  productId    String
  sortOrder    Int        @default(0)
  highlighted  Boolean    @default(false)
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId])
}

model LookbookSlide {
  id               String                     @id @default(cuid())
  collectionId     String
  assetId          String
  sortOrder        Int                        @default(0)
  hotspotProductId String?
  collection       Collection                 @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  asset            MediaAsset                 @relation("LookbookSlideAsset", fields: [assetId], references: [id], onDelete: Cascade)
  translations     LookbookSlideTranslation[]
}

model LookbookSlideTranslation {
  id      String        @id @default(cuid())
  locale  Locale
  title   String
  body    String?
  caption String?
  slideId String
  slide   LookbookSlide @relation(fields: [slideId], references: [id], onDelete: Cascade)

  @@unique([slideId, locale])
}

model EditorialPost {
  id               String                 @id @default(cuid())
  slug             String                 @unique
  category         EditorialCategory
  heroAssetId      String?
  heroAsset        MediaAsset?            @relation("EditorialHeroAsset", fields: [heroAssetId], references: [id])
  publishedAt      DateTime?
  status           ProductStatus          @default(DRAFT)
  seoMeta          Json?
  authorId         String?
  author           User?                  @relation(fields: [authorId], references: [id])
  translations     EditorialTranslation[]
  blocks           EditorialBlock[]
  featuredProducts EditorialFeature[]
}

model EditorialTranslation {
  id             String        @id @default(cuid())
  locale         Locale
  title          String
  standfirst     String?
  bodyRichText   Json?
  seoTitle       String?
  seoDescription String?
  postId         String
  post           EditorialPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, locale])
}

model EditorialBlock {
  id           String                      @id @default(cuid())
  postId       String
  post         EditorialPost               @relation(fields: [postId], references: [id], onDelete: Cascade)
  type         String
  assetId      String?
  asset        MediaAsset?                 @relation(fields: [assetId], references: [id])
  data         Json?
  sortOrder    Int                         @default(0)
  translations EditorialBlockTranslation[]
}

model EditorialBlockTranslation {
  id       String         @id @default(cuid())
  locale   Locale
  headline String?
  body     String?
  caption  String?
  blockId  String
  block    EditorialBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@unique([blockId, locale])
}

model EditorialFeature {
  id        String        @id @default(cuid())
  postId    String
  productId String
  note      String?
  sortOrder Int           @default(0)
  post      EditorialPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  product   Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Cart {
  id         String     @id @default(cuid())
  userId     String?
  user       User?      @relation(fields: [userId], references: [id])
  sessionKey String?    @unique
  currency   Currency   @default(EUR)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  items      CartItem[]
}

model CartItem {
  id                     String                  @id @default(cuid())
  cartId                 String
  variantId              String
  quantity               Int                     @default(1)
  personalizationRequest PersonalizationRequest? @relation("CartItemPersonalization")
  cart                   Cart                    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant                ProductVariant          @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

model Wishlist {
  id         String          @id @default(cuid())
  userId     String?
  user       User?           @relation(fields: [userId], references: [id])
  sessionKey String?         @unique
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  items      WishlistItem[]
}

model WishlistItem {
  id         String    @id @default(cuid())
  wishlistId String
  productId  String
  createdAt  DateTime  @default(now())
  wishlist   Wishlist  @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
}

model Order {
  id                      String            @id @default(cuid())
  number                  String            @unique
  userId                  String?
  user                    User?             @relation(fields: [userId], references: [id])
  status                  OrderStatus       @default(PENDING)
  fulfillmentStatus       FulfillmentStatus @default(NOT_STARTED)
  paymentStatus           PaymentStatus     @default(UNPAID)
  currency                Currency          @default(EUR)
  subtotalCents           Int
  taxCents                Int
  dutiesCents             Int?
  shippingCents           Int
  totalCents              Int
  personalizationFeeCents Int?
  whiteGlove              Boolean           @default(false)
  confirmationEmailSent   Boolean           @default(false)
  placedAt                DateTime          @default(now())
  shippingAddressId       String?
  billingAddressId        String?
  shippingAddress         Address?          @relation("OrderShipping", fields: [shippingAddressId], references: [id])
  billingAddress          Address?          @relation("OrderBilling", fields: [billingAddressId], references: [id])
  items                   OrderItem[]
  payments                PaymentRecord[]
  promotionId             String?
  promotion               Promotion?        @relation(fields: [promotionId], references: [id])
}

model OrderItem {
  id                     String                     @id @default(cuid())
  orderId                String
  variantId              String
  productName            String
  locale                 Locale                     @default(EN)
  unitPriceCents         Int
  quantity               Int
  monogram               String?
  personalizationNotes   String?
  certificate            CertificateOfAuthenticity?
  order                  Order                      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant                ProductVariant             @relation(fields: [variantId], references: [id])
  personalizationRequest PersonalizationRequest?    @relation("OrderItemPersonalization")
}

model PaymentRecord {
  id          String        @id @default(cuid())
  orderId     String
  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  provider    String        @default("stripe")
  providerId  String
  amountCents Int
  currency    Currency      @default(EUR)
  status      PaymentStatus
  data        Json?
  createdAt   DateTime      @default(now())
}

model CertificateOfAuthenticity {
  id          String    @id @default(cuid())
  orderItemId String    @unique
  qrCode      String    @unique
  issuedAt    DateTime  @default(now())
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
}

model Promotion {
  id                 String    @id @default(cuid())
  code               String    @unique
  description        String?
  startsAt           DateTime?
  endsAt             DateTime?
  usageLimit         Int?
  timesUsed          Int       @default(0)
  discountType       String
  discountValue      Int
  locale             Locale?
  limitedEditionOnly Boolean   @default(false)
  orders             Order[]
}

model LimitedDrop {
  id              String          @id @default(cuid())
  collectionId    String
  title           String
  startsAt        DateTime
  endsAt          DateTime?
  waitlistOpen    Boolean         @default(true)
  locale          Locale?
  collection      Collection      @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  waitlistEntries WaitlistEntry[]
}

model WaitlistEntry {
  id        String      @id @default(cuid())
  dropId    String
  productId String?
  email     String
  locale    Locale      @default(EN)
  status    String      @default("pending")
  createdAt DateTime    @default(now())
  drop      LimitedDrop @relation(fields: [dropId], references: [id], onDelete: Cascade)
  product   Product?    @relation(fields: [productId], references: [id])
}

model Appointment {
  id            String   @id @default(cuid())
  userId        String?
  locale        Locale   @default(FR)
  boutique      String   @default("Paris")
  appointmentAt DateTime
  status        String   @default("requested")
  services      String?
  notes         String?
  concierge     String?
  user          User?    @relation(fields: [userId], references: [id])
}

model PersonalizationRequest {
  id          String         @id @default(cuid())
  userId      String?
  cartItemId  String?        @unique
  orderItemId String?        @unique
  variantId   String
  initials    String?
  message     String?
  preferences Json?
  status      String         @default("pending")
  user        User?          @relation(fields: [userId], references: [id])
  variant     ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  cartItem    CartItem?      @relation("CartItemPersonalization", fields: [cartItemId], references: [id])
  orderItem   OrderItem?     @relation("OrderItemPersonalization", fields: [orderItemId], references: [id])
}

model HomepageModule {
  id         String    @id @default(cuid())
  slug       String    @unique
  type       String
  locale     Locale
  config     Json
  activeFrom DateTime?
  activeTo   DateTime?
  sortOrder  Int       @default(0)
}

model ProductSpotlightModule {
  id           String      @id @default(cuid())
  productId    String
  locale       Locale
  headline     String?
  subheading   String?
  assetId      String?
  moduleConfig Json?
  product      Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  asset        MediaAsset? @relation("ProductSpotlightAsset", fields: [assetId], references: [id])

  @@unique([productId, locale])
}

model SearchLog {
  id        String   @id @default(cuid())
  query     String
  locale    Locale
  userId    String?
  ipHash    String?
  createdAt DateTime @default(now())
}
